<!DOCTYPE html>
<head>
<meta charset='utf-8'>
<meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
<meta content='Use Unitwise to persist your Rails ActiveRecord model data as a convertible scientific measurement. | Josh W Lewis: Ruby Developer and JavaScript Engineer' name='description'>
<title>Rails Unit Measurement Persistence | Josh W Lewis: Ruby Developer</title>
<meta content='width=device-width, initial-scale=1.0' name='viewport'>

<script src="../../javascripts/blog/head-8a505cfa.js" type="text/javascript"></script>
<link href="../../stylesheets/blog-33e38085.css" media="screen" rel="stylesheet" type="text/css" />
</head>
<body>
<div id='background'></div>
<div class='container'>
<div class='space' id='headline'>
<img alt='Josh W Lewis' class='avatar' src='/images/joshwlewis-36466eda.jpg'>
<a class='name' href='/'>Josh W Lewis</a>
<span>/</span>
<a href="/essays">Essays</a>
<span>/</span>
<a href="/essays/rails-unit-measurement-persistence">Rails Unit Measurement Persistence</a>
</div>
<div class='surface'>
<h1><a href="/essays/rails-unit-measurement-persistence">Rails Unit Measurement Persistence</a></h1>
<h4>
By
<a href='/' rel='author'>Josh W Lewis</a>
</h4>
<h5>On March 9, 2014</h5>
<p>I&rsquo;ve worked on a few apps in the past that had some cumbersome constraints in
regards to the units of measurement. Models needed to store heat transfer or
fluid dynamics properties in either english or SI units. This is can be a bit
of a pain, so I thought I&rsquo;d share my methods and save someone else the trouble.</p>

<p>My problem scenario was in an engineering realm, but there are plenty of other
mainstream domains that exhibit the problem. Consider foot races &ndash; they are
commonly defined in either mileage (like 26.1 miles for a marathon) or kilometers
(like a 5K). Or consider a mechanic&rsquo;s wrenches &ndash; they have a metric set with
sizes like 10 mm, but also have an english set with sizes like 5/8 inch.</p>

<p>To demonstrate the problem and solution, say you are creating an app for cooks.
Maybe it would let cooks share recipes, perhaps it might be used to help
them decide what to offer on tonight&rsquo;s menu, or perhaps it just tracks ingredient
inventory. In any of those cases, you probably need a model for a recipe and
its ingredients.</p>
<pre class="highlight ruby"><span class="c1"># create_table :recipes do |t|</span>
<span class="c1">#   t.string  :name, null: false</span>
<span class="c1"># end</span>
<span class="k">class </span><span class="nc">Recipe</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:ingredients</span>
<span class="k">end</span>
</pre><pre class="highlight ruby"><span class="c1"># create_table :ingredients do |t|</span>
<span class="c1">#   t.string  :substance,     null: false</span>
<span class="c1">#   t.decimal :quantity,      null: false,  default: 0</span>
<span class="c1">#   t.integer :recipe_id</span>
<span class="c1"># end</span>
<span class="k">class </span><span class="nc">Ingredient</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:recipe</span>
<span class="k">end</span>
</pre>
<p>So, these are some pretty typical models. Sure, they are overly simplified. In
any case, we can setup a new ingredient pretty easily.</p>
<pre class="highlight ruby"><span class="no">Ingredient</span><span class="nf">.create</span><span class="p">(</span><span class="ss">substance: </span><span class="s1">&#39;Olive Oil&#39;</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">1</span><span class="p">)</span>
</pre>
<p>Now we can see the problem. The obvious question here is how much olive oil is
&lsquo;1&rsquo;? Is that one teaspoon, tablespoon, ounce, or maybe even pint or gallon?</p>

<p>In a lot of apps, you might just have some tribal knowledge where everyone
understands that we store quantities in tablespoons. That might be fine in a
lot of cases. But, say we need to know how much olive oil to buy for next week.
Can we buy olive oil by the tablespoon? My olive oil usually comes in 750 ml
bottles. How many tablespoons is that?</p>

<p>It just so happens that I&rsquo;ve built a tool for that. <a href="//github.com/joshwlewis/unitwise">Unitwise</a>
is a Ruby library for converting and performing math on all kinds of units,
volumes included.</p>

<p>Say our grand total of estimated olive oil usage for the week was 1000 tablespoons.
With Unitwise, we could calculate how many bottles of olive oil is required.</p>
<pre class="highlight ruby"><span class="p">(</span><span class="mi">1000</span><span class="nf">.tablespoon</span> <span class="sr">/ 750.ml).to_f # =&gt; 19.715686375000004
</span></pre>
<p>Helpful, but there is a little more we can do here. Instead of relying on
tribal knowledge about storing the quantity in tablespoons, we could make it
explicit.</p>
<pre class="highlight ruby"><span class="k">class </span><span class="nc">Ingredient</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">def </span><span class="nf">quantity</span>
    <span class="n">read_attribute</span><span class="p">(</span><span class="ss">:quantity</span><span class="p">)</span><span class="nf">.to_tablespoon</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
<p>With this modification, each time we retrieve the quantity, we&rsquo;ll get a
measurement back with a value and a unit.</p>
<pre class="highlight ruby"><span class="no">Ingredient</span><span class="nf">.last.quantity</span> <span class="c1"># =&gt; #&lt;Unitwise::Measurement value=1 unit=tablespoon&gt;</span>
</pre>
<p>Unitwise comes with a handy <code>to_s</code> method that should get invoked by your views,
which means you can display this value to your users as <code>&#39;1 tablespoon&#39;</code>.</p>

<p>Cool, but we can make this a little better yet.</p>
<pre class="highlight ruby"><span class="k">class </span><span class="nc">Ingredient</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">def </span><span class="nf">quantity</span>
    <span class="c1"># unchanged from above</span>
  <span class="k">end</span>

  <span class="k">def </span><span class="nf">quantity</span><span class="o">=</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">write_attribute</span><span class="p">(</span><span class="ss">:quantity</span><span class="p">,</span> <span class="n">value</span><span class="nf">.to_tablespoon</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
<p>Now we have the advantage of setting the quantity with any unit compatible
with tablespoons &ndash; that is, any volumetric unit.</p>
<pre class="highlight ruby"><span class="n">tomatoes</span> <span class="o">=</span> <span class="no">Ingredient</span><span class="nf">.create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Crushed tomatoes&#39;</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">8</span><span class="nf">.fluid_ounce</span><span class="p">)</span>
<span class="n">tomatoes</span><span class="nf">.quantity</span> <span class="c1"># =&gt; #&lt;Unitwise::Measurement value=16 unit=tablespoon&gt;</span>
</pre>
<p>With this change, we can now set the quantity with any compatible unit. When
we retrieve the value, it comes back in tablespoons.</p>

<p>We are definitely making progress here. All the values stored and retrieved are
based on tablespoons, no matter what unit you set it with. But, who buys tomatoes
by the tablespoon? When the amount of tomatoes is displayed to the user, they
probably just want to know how many cans (8 fluid ounces) or cups to use.</p>

<p>Lets make one more enhancement. This time, we are going to add a string column
to the ingredients table so we can display an appropriate unit for any
ingredient.</p>
<pre class="highlight ruby"><span class="c1"># create_table :ingredients do |t|</span>
<span class="c1">#   t.string  :substance,     null: false</span>
<span class="c1">#   t.decimal :quantity,      null: false,  default: 0</span>
<span class="c1">#   t.string  :quantity_unit, null: false,  default: &#39;tablespoon&#39;</span>
<span class="c1">#   t.integer :recipe_id,     null: false</span>
<span class="c1"># end</span>

<span class="k">class </span><span class="nc">Ingredient</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>

  <span class="k">def </span><span class="nf">quantity</span>
    <span class="n">read_attribute</span><span class="p">(</span><span class="ss">:quantity</span><span class="p">)</span><span class="nf">.convert_to</span><span class="p">(</span><span class="nb">self</span><span class="nf">.quantity_unit</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def </span><span class="nf">quantity</span><span class="o">=</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">write_attribute</span> <span class="ss">:quantity</span><span class="p">,</span> <span class="n">value</span><span class="nf">.to_tablespoon</span>
    <span class="k">if</span> <span class="n">value</span><span class="nf">.respond_to?</span><span class="p">(</span><span class="ss">:unit</span><span class="p">)</span>
      <span class="nb">self</span><span class="nf">.quantity_unit</span> <span class="o">=</span> <span class="n">value</span><span class="nf">.unit.to_s</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre>
<p>Now we&rsquo;ve got something solid. Now all database entries are stored in the same
unit (tablespoon), which is nice, in case some other program or query wants to do
something with that data. And now whatever unit we set the quantity with is what
gets read into the model. For example:</p>
<pre class="highlight ruby"><span class="n">water</span> <span class="o">=</span> <span class="no">Ingredient</span><span class="nf">.create</span><span class="p">(</span><span class="ss">substance: </span><span class="s1">&#39;Water&#39;</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">1</span><span class="nf">.cup</span><span class="p">)</span>
<span class="n">water</span><span class="nf">.quantity</span> <span class="c1"># =&gt; #&lt;Unitwise::Measurement value=1 unit=cup&gt;</span>

<span class="n">beer</span> <span class="o">=</span> <span class="no">Ingredient</span><span class="nf">.create</span><span class="p">(</span><span class="ss">wine: </span><span class="s1">&#39;Beer&#39;</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">1</span><span class="nf">.pint</span><span class="p">)</span>
<span class="n">beer</span><span class="nf">.quantity</span> <span class="c1"># =&gt; #&lt;Unitwise::Measurmeent value=1 unit=pint&gt;</span>
</pre>
<p>This example is fairly simple, but it should give you an idea of how to do
something similar in your own domain.
<a href="//github.com/joshwlewis/unitwise/">Unitwise</a> supports a ton of units, and has
some other really nice features &ndash; Check it out.</p>

<hr>
<div class='well'>
This article was categorized as
<a href="/essays/categories/ruby">ruby</a>, <a href="/essays/categories/rails">rails</a>, <a href="/essays/categories/gem">gem</a>, <a href="/essays/categories/math">math</a>, and <a href="/essays/categories/science">science</a>
</div>
<div id='disqus_thread'></div>
</div>
<script src="../../javascripts/app/integrations/disqus-579674f1.js" type="text/javascript"></script>

<div class='with-footer'></div>
<footer class='space' id='copyright'>
<span>
Copyright &copy
2016
</span>
<span>
Josh W Lewis
</span>
<span>
<a href='//feeds.feedburner.com/JoshWLewis'>
<i class='icon-rss'></i>
</a>
</span>
</footer>

</div>
<script src="../../javascripts/blog/body-53988f5f.js" type="text/javascript"></script>
</body>

